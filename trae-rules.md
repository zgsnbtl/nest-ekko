# Trae 规则约束文件

## 项目背景
- 使用nestjs框架
- 数据库使用mysql，数据库连接使用typeorm
- 项目采用微服务架构
- 项目使用docker部署

## 1. 总则
- 本规则约束文件旨在规范 Trae IDE 中的开发行为，确保代码质量、一致性和开发效率
- 所有团队成员必须严格遵守本规则
- 规则将根据项目发展和团队反馈定期更新

## 2. 代码风格指南
### 2.1 命名约定
- 变量名: 使用驼峰命名法 (camelCase)，如 `userService`
- 类名: 使用帕斯卡命名法 (PascalCase)，如 `UserController`
- 常量名: 使用大写字母加下划线 (UPPER_CASE)，如 `DB_HOST`
- 文件名: 使用小写字母加连字符 (kebab-case)，如 `user.controller.ts`

### 2.2 格式规范
- 使用 2 个空格缩进
- 每行代码不超过 120 个字符
- 适当使用空行分隔代码块，提高可读性
- 函数参数超过 3 个时，每行一个参数
- 坚持使用单引号 `'` 而非双引号 `"`
- 语句结束不需要分号 `;` (遵循 TypeScript/JavaScript 现代风格)
- 代码格式规范使用prettier格式化代码

## 3. 工具使用规则
### 3.1 搜索工具
- 优先使用 `search_codebase` 进行语义搜索
- 精确匹配时使用 `search_by_regex`
- 搜索时尽量指定目标目录以提高效率

### 3.2 文件编辑工具
- 查看文件内容使用 `view_files`，避免直接编辑未知内容的文件
- 修改小范围代码使用 `update_file` 并提供精确的搜索/替换块
- 大范围修改或创建新文件使用 `write_to_file`
- 编辑现有文件时，必须先查看文件内容和上下文

### 3.3 命令运行工具
- 运行开发服务器使用非阻塞模式 `blocking: false`
- 运行测试或构建命令使用阻塞模式 `blocking: true`
- 避免在同一终端运行多个命令
- 长时间未使用的终端应关闭以释放资源

## 4. 项目结构规范
- 遵循 NestJS 标准项目结构
- 功能模块放在 `src/` 目录下，按业务领域划分
- 公共代码放在 `src/common/` 目录
- 配置文件放在 `src/config/` 目录
- 测试文件与被测试文件放在同一目录下，命名为 `*.spec.ts`
- 环境变量文件放在项目根目录，命名为 `.env.development` 和 `.env.production`

## 5. 环境变量管理
- 所有配置必须通过环境变量加载，禁止硬编码
- 使用 `ConfigService` 获取环境变量
- 环境变量命名使用大写字母加下划线，如 `DB_HOST`
- 敏感信息(如密码)必须放在环境变量中，禁止提交到代码库
- 环境变量必须有默认值，确保应用在缺少某些环境变量时仍能运行

## 6. 测试规范
- 所有服务和控制器必须有单元测试
- 关键业务流程必须有集成测试
- 测试覆盖率不低于 80%
- 使用 `npx ts-node` 运行测试脚本
- 测试前确保环境变量配置正确

## 7. 提交规范
- 提交前必须运行 `npm run lint` 和 `npm run test`
- 提交信息格式: `[类型] 描述`，如 `[feat] 添加用户更新接口`
- 类型包括: feat(新功能), fix(修复bug), docs(文档), style(格式), refactor(重构), test(测试), chore(构建)
- 每次提交只包含一个功能点或 bug 修复

## 8. 安全规范
- 禁止在代码中硬编码密钥和凭证
- 所有用户输入必须进行验证
- API 接口必须有适当的权限控制
- 定期更新依赖包以修复安全漏洞
- 避免使用 `eval()` 和其他可能导致代码注入的函数

## 9. 性能规范
- 避免不必要的数据库查询
- 使用缓存减少重复计算
- 大型数据操作使用流式处理
- API 响应时间不超过 500ms
- 监控内存使用，避免内存泄漏

## 10. 协作规范
- 每日同步代码，避免冲突
- 代码评审前确保代码符合本规则
- 评审意见必须具体、建设性
- 遇到问题及时沟通，避免独自钻研
- 尊重他人代码，不随意修改他人代码